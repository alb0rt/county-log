<!DOCTYPE html>
<html lang="en">




	<link href="/css/bootstrap.min.css" rel="stylesheet"/>
	<link href="/css/style.css" rel="stylesheet"/>

	<style>
		.datalabel {
			color: #b3b;
		}

		.navbar {
			border-bottom: 2px #FF6138;
		}

		.thin-line {
			border-bottom: thick #FF6138;
			color: #FF6138;
		}

	

	</style>
	<body>

		<nav class="navbar navbar-inverse navbar-fixed-top">
			<div class="container">
				<div id="navbar" class="navbar-collapse collapse">

						<div class="col-md-4">
							<div id="county" class="navbar-brand datalabel"></div>
							
						</div>
						<div class="col-md-4">
							<div id="stats" class="datalabel navbar-brand"></div>
						</div>
				</div>
			</div>

		</nav>

		<div class="jumbotron">
			<center><div class="row">
				<div class="col-md-4">
					<div class="checkbox">
						<label>
							<input type="checkbox" id="highway-checkbox"> Interstate Highways
						</label>
					</div>
				</div>
				<div class="col-md-4">
					<div class="checkbox">
						<label>
							<input type="checkbox" id="city-checkbox"> City Labels</input>
						</label>
					</div>
				</div>
				<div class="col-md-4">
					<label>
						<button type="button" id="reset-button" class="btn btn-primary btn-xs"> Reset View </button>
					</label>
			
				</div>
			</div></center>
			<div class="container">
				<center><div id="canvas"></div></center>
				
			</div>
					
		</div>

		<div id="list"></div>	


		<script src="/js/d3.v3.min.js"></script>
		<script src="/js/topojson.v1.min.js"></script>

		<script>


			var width = 960,
				height = 600;

			var path = d3.geo.path()
				.projection(null);

			var visited = [];
			var visitedId = [];


			var svg = d3.select("#canvas").append("svg")
				.attr("width", width)
				.attr("height", height);

			var g = svg.append("g");

			var zoom = d3.behavior.zoom()
				.translate([0, 0])
				.scale(1)
				.scaleExtent([1, 8])
				.on("zoom", zoomed);

			var tooltip;
			var countyList = d3.select("#list").append("ul");

			var NUM_COUNTIES = 3234;
			var stats = d3.select("#stats");
			stats.text("Visited 0 out of " + NUM_COUNTIES + " counties (0%)");

			// register input listeners

			d3.select("#highway-checkbox")
				.on("change", function() {
					var visibility = this.checked ? "visible" : "none";
					g.selectAll(".road")
						.attr("display", visibility);
				});

			d3.select("#city-checkbox")
				.on("change", function() {
					var visibility = this.checked ? "visible" : "none";
					g.selectAll(".city-label")
						.attr("display", visibility);
					g.selectAll(".city")
						.attr("display", visibility);
				});

			d3.select("#reset-button")
				.on("click", function() {
					g.transition()
						.duration(750)
						.attr("transform", "translate([0,0]).scale(1)");
				})


			d3.json("assets/us.json", function(err, us) {
				if(err)
					return console.error(err);

				// Draw counties as features
				g.selectAll(".county")
					.data(topojson.feature(us, us.objects.counties).features)
					.enter()
					.append("path")
					.attr("class", "county")
					.attr("d", path)
					.style("fill", function(d) {
						return "white";		// setting fill color this way increases performance for reasons I dont understand
					})
					.style("stroke", "#ccc")
					.style("stroke-width", "0.5px");

				// Draw state interior borders
				g.append("path")
					.datum(topojson.mesh(us, us.objects.states, function(a, b){ return a !== b}))
					.attr("class", "border")
					.attr("d", path)
					.style("fill", "none")
					.style("stroke", "#000")
					.style("stroke-width", "1px")
					.style("z-index", "100");

				// Draw state exterior borders
				g.append("path")
					.datum(topojson.mesh(us, us.objects.states, function(a, b) {
						return a == b;
					}))
					.attr("class", "border")
					.attr("d", path)
					.style("fill", "none")
					.style("stroke", "#000")
					.style("stroke-width", "1px");

				// Handle mouse interactions with counties
				g.selectAll(".county")
					.on("mouseover", function(d) {	
						d3.select(".arc-label")
							.text(function() {
								return d.properties.NAME;
							});

						if(visitedId.indexOf(d.id) === -1)
							d3.select(this)
								.style("fill", "#e5f7d9");
					})
					.on("click", function(d) {
						if(d3.event.defaultPrevented) return;
						d3.select(this)
							.transition()
							.duration(500)
							.style("fill", toggleStatus(d));
					})
					.on("mouseout", function(d) {
						if(visitedId.indexOf(d.id) === -1)
							d3.select(this)
								.style("fill", "white");
					});
					
					// Create hover tooltip
					tooltip = d3.select("#county")
						.data(topojson.feature(us, us.objects.counties).features)
						.append("div")
						.attr("class", "arc-label-container")
						.style("z-index", "10")
						.style("visibility", "visible");

					// Create tooltip label with filler text
					tooltip.append("div")
						.attr("class", "arc-label")
						.text(function (d) {
							return d.properties.NAME;
						});

					var toggleStatus = function(d) {
						if(visitedId.indexOf(d.id) === -1)
						{
							visitedId.push(d.id);
							visited.push({
								"id" : d.id,
								"name" : d.properties.NAME,
								"stayed" : true
							});

							// add to county list
							countyList
								.append("li")
								.text(function() {
									return d.properties.NAME;
								})
								.attr("id", function() {
									return d.id;
								})

							stats
								.text("Visited " + visited.length + " out of " + NUM_COUNTIES + " counties (" + (visited.length * 100/NUM_COUNTIES).toFixed(3) + "%)");
							return "#00A388";
						} else {
							var index = visitedId.indexOf(d.id);
							if(visited[index].stayed)
							{
								visited[index].stayed = false;
								return "#BEEB9F";
							} else {
								// remove from county list
								d3.select("#" + d.id)
									.text(""); 			// TODO - actually remove the div
								visited.splice(index, 1);
								visitedId.splice(index, 1);
								stats.text("Visited " + visited.length + " out of " + NUM_COUNTIES + " counties (" + (visited.length*100/NUM_COUNTIES).toFixed(3) + "%)");
								return "white";
							}

						}
					}
				
				// Draw interstate highway overlay
				d3.json("assets/roads.json", function(err, us) {
					if(err) 
						return console.error(err);

					g.selectAll(".road")
						.data(topojson.feature(us, us.objects.roads).features)
						.enter()
						.append("path")
						.attr("class", "road")
						.attr("d", path)
						.attr("display", "none")
						.style("fill", function(d) {
							return "none";
						})
						.style("stroke", "#FF6138")
						.style("stroke-width", "0.5px")
						.style("z-index", "100");
				});

				// Draw city name overlay
				d3.json("assets/cities.json", function(err, us) {
					if(err)
						return console.error(err);

					
					g.selectAll(".city")
						.data(topojson.feature(us, us.objects.places).features)
						.enter()
						.append("path")
						.attr("d", path.pointRadius(2))
						.attr("class", "city")
						.attr("display", "none");

					g.selectAll(".city-label")
						.data(topojson.feature(us, us.objects.places).features)
						.enter()
						.append("text")
						.attr("class", "city-label")
						.attr("display", "none")
						.attr("transform", function(d) {
							return "translate(" + d.geometry.coordinates + ")";
						})
						.attr("dy", "0.35em")
						.attr("x", 6)
						.text(function(d) {
							return d.properties.name;
						});		

				});
				
				svg.call(zoom)	

				// disable double click zoom
				svg.on("dblclick.zoom", null);

			});
		
		function zoomed() {
			g.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
		}
			

			
		</script>
		</body>
</html>